<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detector de Localização de Fotos</title>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        height: 100vh;
      }

      .form-container {
        position: absolute;
        top: 15%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 90%;
        max-width: 350px;
        text-align: center;
      }

      .form-container input,
      .form-container button,
      .form-container select {
        width: 100%;
        margin-top: 10px;
      }

      .popup-button {
        background-color: #1d4ed8;
        color: white !important;
        padding: 10px 15px;
        border-radius: 5px;
        text-decoration: none;
        display: inline-block;
        margin-top: 10px;
      }

      #map {
        width: 100%;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="form-container">
      <input
        type="file"
        id="fileInput"
        accept="image/*"
        class="border p-2 rounded"
      />
      <button
        onclick="uploadImage()"
        class="bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
      >
        Enviar
      </button>

      <select
        id="mapStyleSelect"
        class="border p-2 rounded mt-3"
        onchange="changeMapStyle()"
      >
        <option value="mapbox://styles/mapbox/streets-v11">Padrão</option>
        <option value="mapbox://styles/mapbox/satellite-v9">Satelite</option>
        <option value="mapbox://styles/mapbox/dark-v10">Mapa Preto</option>
      </select>
    </div>

    <div id="map"></div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script>
      // Defina o token Mapbox
      mapboxgl.accessToken =
        "pk.eyJ1IjoiY2xlYmVyb2x2IiwiYSI6ImNtN25hb3V2ZjB2b2gybXBybHd2ZXF1ajgifQ.YAFaxUpDyI8W7IV0aVY6FA";

      // Criando o mapa com Mapbox
      const map = new mapboxgl.Map({
        container: "map", // ID do contêiner do mapa
        style: "mapbox://styles/mapbox/streets-v11", // Estilo do mapa inicial
        center: [0, 0], // Posição inicial do mapa
        zoom: 2, // Zoom inicial
      });

      // Função para mudar o estilo do mapa
      function changeMapStyle() {
        const selectedStyle = document.getElementById("mapStyleSelect").value;
        console.log("Estilo selecionado:", selectedStyle); // Adicionando log para verificar o estilo selecionado
        map.setStyle(selectedStyle);
      }

      // Variável para o marcador
      let marker;

      function uploadImage() {
        const fileInput = document.getElementById("fileInput");
        if (!fileInput.files.length) {
          alert("Selecione uma imagem primeiro!");
          return;
        }

        const formData = new FormData();
        formData.append("image", fileInput.files[0]);

        const file = fileInput.files[0];

        // Lê a imagem e extrai os dados EXIF
        readExifData(file);
      }

      // Função para extrair as coordenadas EXIF e converter para formato decimal
      function readExifData(file) {
        EXIF.getData(file, function () {
          // Pegando as coordenadas de latitude e longitude
          const latitude = EXIF.getTag(this, "GPSLatitude");
          const longitude = EXIF.getTag(this, "GPSLongitude");

          // Pegando as referências (S ou N para latitude, W ou E para longitude)
          const latitudeRef = EXIF.getTag(this, "GPSLatitudeRef");
          const longitudeRef = EXIF.getTag(this, "GPSLongitudeRef");

          if (latitude && longitude && latitudeRef && longitudeRef) {
            console.log("Latitude antes de converter:", latitude);
            console.log("Longitude antes de converter:", longitude);

            // Convertendo as coordenadas de DMS para decimal
            const latitudeDecimal = convertToDecimal(latitude, latitudeRef);
            const longitudeDecimal = convertToDecimal(longitude, longitudeRef);

            console.log("Latitude convertida:", latitudeDecimal);
            console.log("Longitude convertida:", longitudeDecimal);

            // Passar as coordenadas para o mapa
            if (!isNaN(latitudeDecimal) && !isNaN(longitudeDecimal)) {
              map.flyTo({
                center: [longitudeDecimal, latitudeDecimal],
                zoom: 15,
              });

              if (marker) marker.remove();
              marker = new mapboxgl.Marker()
                .setLngLat([longitudeDecimal, latitudeDecimal])
                .addTo(map)
                .setPopup(
                  new mapboxgl.Popup().setHTML(
                    `<b>Localização da Foto</b><br><br>Lat: ${latitudeDecimal}, <br>Lng: ${longitudeDecimal}<br><br><a href="https://www.google.com/maps/search/?api=1&query=${latitudeDecimal},${longitudeDecimal}" target="_blank" class="popup-button">Ver no Google Maps</a>`
                  )
                )
                .togglePopup();
            } else {
              alert("A imagem não possui coordenadas GPS válidas.");
            }
          } else {
            alert("Esta imagem não contém coordenadas EXIF.");
          }
        });
      }

      // Função para converter de DMS para decimal
      function convertToDecimal(degreesMinutesSeconds, reference) {
        const degrees = degreesMinutesSeconds[0];
        const minutes = degreesMinutesSeconds[1];
        const seconds = degreesMinutesSeconds[2];

        let decimal = degrees + minutes / 60 + seconds / 3600;

        // Se a referência for 'S' ou 'W', o valor é negativo
        if (reference === "S" || reference === "W") {
          decimal = -decimal;
        }

        return decimal;
      }
    </script>
  </body>
</html>
